// ====== OVERLAY 'VITA-OV' ======
// store offset = 0xf170
// overlay size   = 0x03f0

#include"../../emul/cpu.h"

#include"../data.h"
#include"../../emul/starflt1.h"


// =================================
// =========== DICTIONARY ==========
// =================================
//      UNK_0xf18a  codep:0x2214 parp:0xf18a size:0x0026 C-string:'UNK_0xf18a'
//      UNK_0xf1b2  codep:0x7394 parp:0xf1b2 size:0x0016 C-string:'UNK_0xf1b2'
//      UNK_0xf1ca  codep:0x7394 parp:0xf1ca size:0x004e C-string:'UNK_0xf1ca'
//      UNK_0xf21a  codep:0x7394 parp:0xf21a size:0x0006 C-string:'UNK_0xf21a'
//      UNK_0xf222  codep:0x7394 parp:0xf222 size:0x003e C-string:'UNK_0xf222'
//      UNK_0xf262  codep:0x7394 parp:0xf262 size:0x0006 C-string:'UNK_0xf262'
//      UNK_0xf26a  codep:0x7394 parp:0xf26a size:0x0006 C-string:'UNK_0xf26a'
//      UNK_0xf272  codep:0x7420 parp:0xf272 size:0x0003 C-string:'UNK_0xf272'
//      UNK_0xf277  codep:0x224c parp:0xf277 size:0x0006 C-string:'UNK_0xf277'
//      UNK_0xf27f  codep:0x224c parp:0xf27f size:0x000a C-string:'UNK_0xf27f'
//      UNK_0xf28b  codep:0x224c parp:0xf28b size:0x0008 C-string:'UNK_0xf28b'
//      UNK_0xf295  codep:0x224c parp:0xf295 size:0x000a C-string:'UNK_0xf295'
//      UNK_0xf2a1  codep:0x224c parp:0xf2a1 size:0x0014 C-string:'UNK_0xf2a1'
//      UNK_0xf2b7  codep:0x224c parp:0xf2b7 size:0x00f1 C-string:'UNK_0xf2b7'
//      UNK_0xf3aa  codep:0x224c parp:0xf3aa size:0x0036 C-string:'UNK_0xf3aa'
//        A.DENSIT  codep:0xf2bf parp:0xf3ed size:0x000e C-string:'A_dot_DENSIT'
//        PLANET.G  codep:0xf2bf parp:0xf408 size:0x000e C-string:'PLANET_dot_G'
//      UNK_0xf418  codep:0x224c parp:0xf418 size:0x0026 C-string:'UNK_0xf418'
//      UNK_0xf440  codep:0x224c parp:0xf440 size:0x001c C-string:'UNK_0xf440'
//      UNK_0xf45e  codep:0x224c parp:0xf45e size:0x0014 C-string:'UNK_0xf45e'
//      UNK_0xf474  codep:0x224c parp:0xf474 size:0x004c C-string:'UNK_0xf474'
//             DIO  codep:0x224c parp:0xf4c8 size:0x0000 C-string:'DIO'

// =================================
// ============= EXTERN ============
// =================================
extern const unsigned short int pp__n_SHOTS; // #SHOTS
extern const unsigned short int pp_FILE_n_; // FILE#
extern const unsigned short int pp_RECORD_n_; // RECORD#
extern const unsigned short int pp_PLHI; // PLHI
extern const unsigned short int pp_FSTUN; // FSTUN
extern const unsigned short int pp_SUPER_dash_B; // SUPER-B
extern const unsigned short int pp__ro_PLANET; // (PLANET
extern const unsigned short int pp__ro_SURFAC; // (SURFAC
extern Color WHITE; // WHITE
void _star__slash_(); // */
void _co_(); // ,
void RRND(); // RRND
void C_ex__2(); // C!_2
void Store_2(); // !_2
void _1_dot_5_ex__2(); // 1.5!_2
void ON_2(); // ON_2
void _099(); // 099
void FILL_2(); // FILL_2
void CDROP(); // CDROP
void CI_i_(); // CI'
void SET_dash_CUR(); // SET-CUR
void ICLOSE(); // ICLOSE
void _gt_C_plus_S(); // >C+S
void IOPEN(); // IOPEN
void IINSERT(); // IINSERT
void IFLD_at_(); // IFLD@
void IFIND(); // IFIND
void ICREATE(); // ICREATE
void _star_CREATE(); // *CREATE
void StoreCOLOR(); // !COLOR
void DrawTTY(); // .TTY
void _2DUP(); // 2DUP
void _2SWAP(); // 2SWAP
void OVER(); // OVER
void _dash_(); // -
void _1_dot_5_at_(); // 1.5@
void CI(); // CI


// =================================
// =========== VARIABLES ===========
// =================================

const unsigned short int cc_UNK_0xf18a = 0xf18a; // UNK_0xf18a


// 0xf182: db 0x3e 0x00 0x14 0x22 0x20 0x00 '>  "  '

// ================================================
// 0xf188: WORD 'UNK_0xf18a' codep=0x2214 parp=0xf18a
// ================================================
// 0xf18a: dw 0x0043
// 0xf18c: db 0x14 0x22 0x44 0x00 0x94 0x73 0x20 0x0c 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x0d 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x0e 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x09 0x01 0x17 0x49 0x6c ' "D  s    Il s    Il s    Il s    Il'

// ================================================
// 0xf1b0: WORD 'UNK_0xf1b2' codep=0x7394 parp=0xf1b2
// ================================================
LoadDataType UNK_0xf1b2 = {BOXIDX, 0x11, 0x02, 0x10, 0x6a7d};
// 0xf1b8: db 0x94 0x73 0x20 0x00 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x02 0x02 0x17 0x49 0x6c ' s    Il s    Il'

// ================================================
// 0xf1c8: WORD 'UNK_0xf1ca' codep=0x7394 parp=0xf1ca
// ================================================
LoadDataType UNK_0xf1ca = {PLANETIDX, 0x04, 0x01, 0x17, 0x6c49};
// 0xf1d0: db 0x94 0x73 0x20 0x05 0x02 0x17 0x49 0x6c 0x94 0x73 0x20 0x0f 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x10 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x11 0x02 0x17 0x49 0x6c 0x94 0x73 0x20 0x13 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x14 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x15 0x01 0x17 0x49 0x6c 0x94 0x73 0x20 0x16 0x01 0x17 0x49 0x6c 0x94 0x73 0x43 0x02 0x02 0x1c 0xfc 0x6e ' s    Il s    Il s    Il s    Il s    Il s    Il s    Il s    Il sC    n'

// ================================================
// 0xf218: WORD 'UNK_0xf21a' codep=0x7394 parp=0xf21a
// ================================================
LoadDataType UNK_0xf21a = {REGIONSIDX, 0x07, 0x08, 0x1c, 0x6efc};

// ================================================
// 0xf220: WORD 'UNK_0xf222' codep=0x7394 parp=0xf222
// ================================================
LoadDataType UNK_0xf222 = {REGIONSIDX, 0x0f, 0x01, 0x1c, 0x6efc};
// 0xf228: db 0x94 0x73 0x43 0x0f 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x10 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x10 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x11 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x11 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x12 0x01 0x1c 0xfc 0x6e 0x94 0x73 0x43 0x12 0x01 0x1c 0xfc 0x6e ' sC    n sC    n sC    n sC    n sC    n sC    n sC    n'

// ================================================
// 0xf260: WORD 'UNK_0xf262' codep=0x7394 parp=0xf262
// ================================================
LoadDataType UNK_0xf262 = {REGIONSIDX, 0x13, 0x08, 0x1c, 0x6efc};

// ================================================
// 0xf268: WORD 'UNK_0xf26a' codep=0x7394 parp=0xf26a
// ================================================
LoadDataType UNK_0xf26a = {REGIONSIDX, 0x1b, 0x01, 0x1c, 0x6efc};

// ================================================
// 0xf270: WORD 'UNK_0xf272' codep=0x7420 parp=0xf272
// ================================================
IFieldType UNK_0xf272 = {REGIONSIDX, 0x0b, 0x02};

// ================================================
// 0xf275: WORD 'UNK_0xf277' codep=0x224c parp=0xf277 params=3 returns=1
// ================================================

void UNK_0xf277() // UNK_0xf277
{
  _2DUP(); // 2DUP
  IFIND(); // IFIND
}


// ================================================
// 0xf27d: WORD 'UNK_0xf27f' codep=0x224c parp=0xf27f
// ================================================

void UNK_0xf27f() // UNK_0xf27f
{
  Push(0);
  Push(0x0100);
  RRND(); // RRND
}


// ================================================
// 0xf289: WORD 'UNK_0xf28b' codep=0x224c parp=0xf28b
// ================================================

void UNK_0xf28b() // UNK_0xf28b
{
  Push(0);
  Push(2);
  RRND(); // RRND
}


// ================================================
// 0xf293: WORD 'UNK_0xf295' codep=0x224c parp=0xf295
// ================================================

void UNK_0xf295() // UNK_0xf295
{
  Push(1);
  Push(0x0064);
  RRND(); // RRND
}


// ================================================
// 0xf29f: WORD 'UNK_0xf2a1' codep=0x224c parp=0xf2a1 params=3 returns=1
// ================================================

void UNK_0xf2a1() // UNK_0xf2a1
{
  unsigned short int a;
  a = Pop(); // >R
  Push(Pop() + 1); //  1+
  OVER(); // OVER
  _dash_(); // -
  Push(a); // R>
  Push(0x0100);
  _star__slash_(); // */
  Push(Pop() + Pop()); // +
}


// ================================================
// 0xf2b5: WORD 'UNK_0xf2b7' codep=0x224c parp=0xf2b7
// ================================================

void UNK_0xf2b7() // UNK_0xf2b7
{
  Exec("CREATE"); // call of word 0x1cbb '(CREATE)'
  Push(0);
  _co_(); // ,
  CODE(); // (;CODE) inlined assembler code
// 0xf2bf: call   1649
  OVER(); // OVER
  Push(Pop() + Pop()); // +
  Push(Pop() + Pop()); // +
  Push(Read16(Pop())); //  @
}

// 0xf2cc: db 0x4c 0x22 0x41 0x0e 0xae 0x0b 0x15 0x10 0xe7 0x3e 0x15 0x10 0x90 0x16 0x4c 0x22 0x4f 0x06 0x97 0x3b 0xb3 0x0f 0x41 0x0e 0x93 0x1f 0xed 0x22 0x7f 0x0e 0x8c 0x21 0xf2 0x0e 0x20 0x0f 0x9d 0x6d 0xfa 0x1b 0xe8 0x52 0x23 0x20 0x0f 0x87 0x3b 0x9b 0x3f 0x87 0x3b 0x9b 0x3f 0x87 0x3b 0x9b 0x3f 0xcc 0xf2 0xb8 0x15 0x50 0x0e 0x38 0x0c 0x7f 0x3b 0x7c 0x3f 0x5f 0x12 0xb4 0x0d 0x7f 0x3b 0x7c 0x3f 0x5f 0x12 0x90 0x0e 0xf5 0x12 0xfa 0x15 0x10 0x00 0x50 0x0e 0x87 0x3b 0x9b 0x3f 0x32 0x0e 0xb3 0x0e 0xb3 0x0e 0x4a 0x17 0x97 0x3b 0x5c 0x15 0xd4 0xff 0xde 0x0d 0xc8 0x0d 0xfa 0x15 0x0c 0x00 0x87 0x3b 0x72 0x0f 0xae 0x0b 0x60 0x16 0x29 0x00 0xdc 0x1b 0x20 0x49 0x4e 0x44 0x45 0x58 0x20 0x4e 0x4f 0x54 0x20 0x49 0x4e 0x20 0x50 0x52 0x4f 0x42 0x41 0x42 0x49 0x4c 0x49 0x54 0x59 0x20 0x41 0x52 0x52 0x41 0x59 0x21 0x20 0x6c 0x3a 0x3f 0x90 0x90 0x16 0x4c 0x22 0x7f 0x0e 0x7f 0x0e 0x92 0x0c 0x41 0x0e 0x5d 0x17 0x64 0x00 0x5f 0x12 0x07 0x13 0xb4 0x0d 0x2d 0x12 0x90 0x0e 0xf5 0x12 0xfa 0x15 0x0a 0x00 0xe7 0x0f 0x70 0x4a 0x60 0x16 0xde 0xff 0x90 0x16 0x4c 0x22 0x72 0xf3 0xe7 0x0f 0x83 0x4a 0xb3 0x0e 0x32 0x0e 0x90 0x16 'L"A      >    L"O  ;  A    "  !     m   R#   ; ? ; ? ; ?    P 8 ;|?_   ;|?_         P  ; ?2     J  ;\            ;r   ` )    INDEX NOT IN PROBABILITY ARRAY! l:?   L"    A ] d _     -           pJ`     L"r    J  2   '

// ================================================
// 0xf3a8: WORD 'UNK_0xf3aa' codep=0x224c parp=0xf3aa params=3 returns=0
// ================================================

void UNK_0xf3aa() // UNK_0xf3aa
{
  unsigned short int i, imax;
  Push(pp__ro_PLANET); // (PLANET
  _1_dot_5_at_(); // 1.5@
  _gt_C_plus_S(); // >C+S
  IOPEN(); // IOPEN
  Push(Read16(cc_UNK_0xf18a)); // UNK_0xf18a
  Push(0);
  IFIND(); // IFIND
  Push(Pop()==0?1:0); //  0=
  if (Pop() == 0) return;
  ICLOSE(); // ICLOSE
  Push(0xf1e2);
  IFLD_at_(); // IFLD@
  Push(Pop() + 1); //  1+
  Push(0xf1da);
  IFLD_at_(); // IFLD@
  IOPEN(); // IOPEN

  i = Pop();
  imax = Pop();
  do // (DO)
  {
    Push(Read16(cc_UNK_0xf18a)); // UNK_0xf18a
    Push(i); // I
    Push(1);
    _star_CREATE(); // *CREATE
    i++;
  } while(i<imax); // (LOOP)

}


// ================================================
// 0xf3e0: WORD 'A.DENSIT' codep=0xf2bf parp=0xf3ed
// ================================================
// 0xf3ed: db 0x00 0x00 0x9c 0xff 0xe2 0xff 0xf1 0xff 0x00 0x00 0x00 0x00 0xe2 0xff '              '

// ================================================
// 0xf3fb: WORD 'PLANET.G' codep=0xf2bf parp=0xf408
// ================================================
// 0xf408: db 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xf6 0xff 0xe2 0xff 0xb0 0xff '              '

// ================================================
// 0xf416: WORD 'UNK_0xf418' codep=0x224c parp=0xf418
// ================================================

void UNK_0xf418() // UNK_0xf418
{
  Push(0);
  Push(0x65e1+UNK_0xf272.offset); // UNK_0xf272<IFIELD>
  Store_2(); // !_2
  LoadData(UNK_0xf222); // from 'REGIONS'
  Push(4);
  Push(0);
  FILL_2(); // FILL_2
  LoadData(UNK_0xf21a); // from 'REGIONS'
  Push(8);
  Push(0);
  FILL_2(); // FILL_2
  LoadData(UNK_0xf262); // from 'REGIONS'
  Push(8);
  Push(0);
  FILL_2(); // FILL_2
  Push(0);
  LoadData(UNK_0xf26a); // from 'REGIONS'
  C_ex__2(); // C!_2
}


// ================================================
// 0xf43e: WORD 'UNK_0xf440' codep=0x224c parp=0xf440
// ================================================

void UNK_0xf440() // UNK_0xf440
{
  unsigned short int i, imax;
  Push(Read16(cc_UNK_0xf18a)); // UNK_0xf18a
  Push(pp_FILE_n_); // FILE#
  Store_2(); // !_2
  Push(6);
  Push(0);

  i = Pop();
  imax = Pop();
  do // (DO)
  {
    Push(i); // I
    Push(pp_RECORD_n_); // RECORD#
    Store_2(); // !_2
    UNK_0xf418(); // UNK_0xf418
    i++;
  } while(i<imax); // (LOOP)

  SET_dash_CUR(); // SET-CUR
}


// ================================================
// 0xf45c: WORD 'UNK_0xf45e' codep=0x224c parp=0xf45e params=3 returns=1
// ================================================

void UNK_0xf45e() // UNK_0xf45e
{
  Push(pp__ro_PLANET); // (PLANET
  _1_dot_5_at_(); // 1.5@
  _gt_C_plus_S(); // >C+S
  IOPEN(); // IOPEN
  Push(0x000b);
  Push(0x002e);
  IFIND(); // IFIND
}


// ================================================
// 0xf472: WORD 'UNK_0xf474' codep=0x224c parp=0xf474
// ================================================

void UNK_0xf474() // UNK_0xf474
{
  UNK_0xf45e(); // UNK_0xf45e
  Push(Pop()==0?1:0); //  0=
  if (Pop() != 0)
  {
    Push(0x000b);
    Push(0x002e);
    ICREATE(); // ICREATE
    _2DUP(); // 2DUP
    Push(pp__ro_PLANET); // (PLANET
    _1_dot_5_at_(); // 1.5@
    IINSERT(); // IINSERT
    Push(0x000b);
    Push(0x002c);
    ICREATE(); // ICREATE
    _2SWAP(); // 2SWAP
    IINSERT(); // IINSERT
    CDROP(); // CDROP
    ICLOSE(); // ICLOSE
    UNK_0xf45e(); // UNK_0xf45e
    Pop(); // DROP
  }
  CI(); // CI
  Push(pp_SUPER_dash_B); // SUPER-B
  _1_dot_5_ex__2(); // 1.5!_2
  IOPEN(); // IOPEN
  CI(); // CI
  Push(pp__ro_SURFAC); // (SURFAC
  _1_dot_5_ex__2(); // 1.5!_2
  Push(0);
  LoadData(UNK_0xf1b2); // from 'BOX'
  Store_2(); // !_2
  ICLOSE(); // ICLOSE
  ICLOSE(); // ICLOSE
  ICLOSE(); // ICLOSE
}


// ================================================
// 0xf4c0: WORD 'DIO' codep=0x224c parp=0xf4c8
// ================================================
// entry

void DIO() // DIO
{
  Push(pp_PLHI); // PLHI
  _099(); // 099
  Push(pp_FSTUN); // FSTUN
  _099(); // 099
  SetColor(WHITE);
  StoreCOLOR(); // !COLOR
  SET_STR_AS_PARAM("AUTO SAMPLING DEVICES ACTIVATED");
  DrawTTY(); // .TTY
  UNK_0xf3aa(); // UNK_0xf3aa
  UNK_0xf440(); // UNK_0xf440
  UNK_0xf474(); // UNK_0xf474
  CI_i_(); // CI'
  _gt_C_plus_S(); // >C+S
  LoadData(UNK_0xf1ca); // from 'PLANET'
  Push(Read16(Pop())&0xFF); //  C@
  ICLOSE(); // ICLOSE
  if (Pop() == 0) goto label1;
  Push(pp_PLHI); // PLHI
  ON_2(); // ON_2
  goto label1;

  label1:
  SET_STR_AS_PARAM("PERFORMING HULL INTEGRITY CHECK");
  DrawTTY(); // .TTY
  ICLOSE(); // ICLOSE
  ICLOSE(); // ICLOSE
  Push(pp__n_SHOTS); // #SHOTS
  _099(); // 099
}

// 0xf542: db 0x56 0x49 0x54 0x41 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x5f 0x00 'VITA__________________________ '

